{% extends "platform_admin/base_admin.html" %}
{% block admin_title %}Audit Logs{% endblock %}
{% block admin_content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h4 fw-bold mb-1">Audit Logging</h1>
            <p class="text-muted mb-0">Immutable record of Super Admin actions.</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="window.location.reload()" title="Refresh">
                <i class="fas fa-sync-alt"></i>
            </button>
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'platform_admin:dashboard' %}">Back to dashboard</a>
        </div>
    </div>

    <!-- Search and Filter Bar -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search by action, actor, or description...">
                    </div>
                </div>
                <div class="col-md-4">
                    <select id="entityFilter" class="form-select">
                        <option value="">All Entity Types</option>
                        <option value="user">User</option>
                        <option value="institution">Institution</option>
                        <option value="institution_admin">Institution Admin</option>
                        <option value="demo_request">Demo Request</option>
                        <option value="setting">Setting</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button id="clearFilters" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive shadow-sm rounded bg-white">
        <table class="table align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Action</th>
                    <th>Actor</th>
                    <th>Entity</th>
                    <th>Description</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr>
                    <td class="fw-semibold">{{ log.action }}</td>
                    <td class="text-muted">{{ log.actor }}</td>
                    <td class="small text-muted">{{ log.entity_type }} {{ log.entity_id }}</td>
                    <td class="small">{{ log.description }}</td>
                    <td class="small text-muted">{{ log.created_at|date:"Y-m-d H:i" }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center text-muted py-4">No audit events captured yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>

    <script>
        // Search and Filter functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const entityFilter = document.getElementById('entityFilter');
            const clearBtn = document.getElementById('clearFilters');
            const tableRows = document.querySelectorAll('.table tbody tr');

            function filterTable() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedEntity = entityFilter.value.toLowerCase();

                tableRows.forEach(row => {
                    if (row.querySelector('td[colspan]')) return;

                    const action = row.children[0]?.textContent.toLowerCase() || '';
                    const actor = row.children[1]?.textContent.toLowerCase() || '';
                    const entity = row.children[2]?.textContent.toLowerCase() || '';
                    const description = row.children[3]?.textContent.toLowerCase() || '';

                    const matchesSearch = action.includes(searchTerm) || 
                                        actor.includes(searchTerm) || 
                                        description.includes(searchTerm);
                    const matchesEntity = !selectedEntity || entity.includes(selectedEntity);

                    row.style.display = (matchesSearch && matchesEntity) ? '' : 'none';
                });

                const visibleRows = Array.from(tableRows).filter(row => 
                    row.style.display !== 'none' && !row.querySelector('td[colspan]')
                );

                if (visibleRows.length === 0) {
                    let emptyRow = document.querySelector('.no-results-row');
                    if (!emptyRow) {
                        emptyRow = document.createElement('tr');
                        emptyRow.className = 'no-results-row';
                        emptyRow.innerHTML = '<td colspan="5" class="text-center text-muted py-4"><i class="fas fa-search"></i> No matching audit logs found.</td>';
                        document.querySelector('.table tbody').appendChild(emptyRow);
                    }
                    emptyRow.style.display = '';
                } else {
                    const emptyRow = document.querySelector('.no-results-row');
                    if (emptyRow) emptyRow.style.display = 'none';
                }
            }

            searchInput.addEventListener('input', filterTable);
            entityFilter.addEventListener('change', filterTable);

            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                entityFilter.value = '';
                filterTable();
            });
        });
    </script>
{% endblock %}
